#!/bin/bash

# Set ENV files
export CONSUL_PORT={{ consul_api_port }}
export CONSUL_HOSTNAME={{ ansible_default_ipv4.address }}
export VAULT_PORT=65240

# Add upstart files
echo {{ krain_base64['stdout'] }} | base64 --decode >> /etc/init/krain.conf
echo {{ charon_base64['stdout'] }} | base64 --decode >> /etc/init/charon.conf

# Create directory for env
mkdir /opt/runnable/dock-init/consul-resources/vault/{{ node_env }}"
chown ubuntu:ubuntu /opt/runnable/dock-init/consul-resources/vault/{{ node_env }}"
chmod 0711 /opt/runnable/dock-init/consul-resources/vault/{{ node_env }}"

# Set Vault Tokens
{% for item in tokens %}
echo {{ item.value }} >> /opt/runnable/dock-init/consul-resources/vault/{{ node_env }}/{{ item.file_name }}
{% endfor %}

# Start services
start amazon-ssm-agent
service krain start
service charon start vault server --config=/tmp/vault.hcl > /tmp/log 2>&1 &
