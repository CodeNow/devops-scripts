---
- name: get ports from eru
  delegate_to: "{{ groups['eru'][0] }}"
  tags: [ config, deploy ]
  become: true
  shell: |
    for c in $(docker ps | awk '/eru/{ print $1 }'); do
      docker port $c 5501 | cut -d ':' -f 2
      docker port $c 5502 | cut -d ':' -f 2
    done
  args:
    executable: /bin/bash
  register: ports

- name: register IP as variable
  tags: [ config, deploy ]
  set_fact:
    eru_server_hostname: "{{ hostvars[groups['eru'][0]].ansible_default_ipv4.address }}"

- name: make nginx config directory
  tags: [ config, deploy ]
  become: yes
  file:
    state: directory
    dest: /etc/nginx

- name: put configuration in place
  tags: [ config, deploy ]
  become: yes
  template:
    src: "{{ item }}"
    dest: /etc/nginx/sites-available/{{ item }}
  with_items:
    - 11-eru-server.conf

- name: link configuration
  tags: [ config, deploy ]
  become: yes
  file:
    state: link
    dest: /etc/nginx/sites-enabled/{{ item }}
    src: /etc/nginx/sites-available/{{ item }}
  with_items:
    - 11-eru-server.conf

- name: reload nginx
  tags: [ config, deploy ]
  become: yes
  shell: docker ps | awk '/nginx/{ print $1 }' | xargs -n 1 docker kill --signal SIGHUP
