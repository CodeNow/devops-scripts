---
# check if dockhost already in redis
- name: look for docker host in redis docks list
  command: sudo docker run --rm redis redis-cli -h {{redis_host}} lrange {{dock_hosts_key}} 0 -1
  register: docks_key
  changed_when: docks_key.stdout.find("{{ansible_default_ipv4.address}}") == -1

# check keys
- name: look for docker host's meta hash in redis
  command: sudo docker run --rm redis redis-cli -h {{redis_host}} hlen http://{{ansible_default_ipv4.address}}:4242
  register: dock_hash_key
  changed_when: dock_hash_key.stdout == "0"

# create hash key for the box
- name: create redis hash key for dock box
  when: dock_hash_key.stdout == "0"
  command: sudo docker run --rm redis redis-cli -h {{redis_host}} hmset http://{{ansible_default_ipv4.address}}:4242 numContainers 0 numBuilds 0 host http://{{ansible_default_ipv4.address}}:4242

# add docker host to the list of hosts
- name: add docker host to available docks in redis
  when: docks_key.stdout.find("{{ansible_default_ipv4.address}}") == -1
  command: sudo docker run --rm redis redis-cli -h {{redis_host}} rpush {{dock_hosts_key}} http://{{ansible_default_ipv4.address}}:4242
