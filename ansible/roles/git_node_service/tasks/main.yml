---
- name: create {{ app_name }} repository dir
  sudo: yes
  file:
    path=/opt/runnable/{{ app_name }}
    state=directory
    owner={{ ansible_env.USER }}

- name: pull the git repository
  sudo: yes
  git:
    repo={{ app_repo }}
    dest=/opt/runnable/{{ app_name }}
    version={{ git_branch }}
    update=yes
    accept_hostkey=True
    force=yes
    key_file=/opt/runnable/dock-init/key/id_rsa_runnabledock

- name: remove node_modules
  sudo: yes
  when: do_not_remove is not defined
  file:
    path=/opt/runnable/{{ app_name }}/node_modules
    state=absent

- name: npm install {{ app_name }}
  sudo: yes
  npm:
    path=/opt/runnable/{{ app_name }}
    state=latest
    production=yes

- name: restart service {{ app_name }}
  sudo: yes
  service:
    name={{ app_name }}
    state=restarted
    enabled=yes
