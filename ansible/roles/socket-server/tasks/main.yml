---
- name: get ports from socket-server
  delegate_to: "{{ groups['socket-server'][0] }}"
  become: true
  shell: "for c in $(docker ps | awk '/api-socket-server/{ print $1 }'); do docker port $c 80 | cut -d ':' -f 2; done"
  args:
    executable: /bin/bash
  register: ports

- name: register socket server IP as variable
  set_fact:
    socket_server_hostname: "{{ hostvars[groups['socket-server'][0]].ansible_default_ipv4.address }}"

- name: remove any nginx configs
  become: yes
  file:
    name: /etc/nginx/sites-enabled/{{ item }}
    state: absent
  with_items: present_configs.stdout_lines

- name: put configuration in place
  become: yes
  template:
    src: 01-socket-server.conf
    dest: /etc/nginx/sites-available/01-socket-server.conf
  notify:
  - reload nginx
