---
- fail: msg="value tokens need to be defined for this role"
  when: vault_auth_token is not defined or vault_token_01 is not defined or vault_token_02 is not defined or vault_token_03 is not defined

- name: copy vault auth files
  tags: vault_files
  lineinfile:
    dest="/opt/runnable/dock-init/consul-resources/vault/{{ node_env }}/{{ item.file_name }}"
    line="{{ item.value }}"
    create=yes
    mode="0400"
  with_items:
  - { file_name: 'auth-token', value: "{{ vault_auth_token }}" }
  - { file_name: 'token-01', value: "{{ vault_token_01 }}" }
  - { file_name: 'token-02', value: "{{ vault_token_02 }}" }
  - { file_name: 'token-03', value: "{{ vault_token_03 }}" }

- fail: msg="value tokens need to be defined for this role"
  when: docks_rollbar_key is not defined

- name: copy rollbar token
  tags: rollbar
  lineinfile:
    dest="/opt/runnable/dock-init/key/rollbar.token"
    line="{{ docks_rollbar_key }}"
    create=yes

- name: docker upstart override
  sudo: yes
  lineinfile:
    dest="/etc/init/docker.override"
    line="manual"
    create=yes

- name: create ssh config for root
  sudo: yes
  lineinfile:
    dest="/root/.ssh/config"
    line="StrictHostKeyChecking no"
    create=yes

- name: enforce sane permissions for dock-init RSA keys
  become: true
  file:
    owner="root"
    group="root"
    path="/opt/runnable/dock-init/key/id_rsa_runnabledock"
    mode="0400"
