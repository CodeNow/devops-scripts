---
- name: make /etc/consul.d folder
  sudo: yes
  file:
    path=/etc/consul.d
    state=directory

- name: remove all current configs
  sudo: yes
  shell: rm -f /etc/consul.d/*.json

- name: put service files in place
  sudo: yes
  template:
    dest=/etc/consul.d/{{ item.name }}.json
    src=service.json
  with_items:
    - name: 'datadog'
      host_address: '{{ datadog_host_address }}'
      tags: ['master']
      port: 8125
    - name: 'rabbitmq'
      host_address: '{{ rabbit_host_address }}'
      tags: ['master']
      port: '{{ rabbit_port }}'
    - name: 'redis'
      host_address: '{{ redis_host_address }}'
      tags: ['master']
      port: '{{ redis_port }}'
    - name: 'registry'
      host_address: '{{ registry_host }}'
      tags: ['master']
      port: 80

- name: send consul SIGUP to reload services
  sudo: yes
  shell: pkill --signal SIGHUP consul
