- name: ensure dock_init_version is defined
  fail: msg="`dock_init_version` is not defined"
  when: dock_init_version is not defined

- name: ensure image_builder_version is defined
  fail: msg="`image_builder_version` is not defined"
  when: image_builder_version is not defined

- name: find ami
  when: ami_id is not defined
  register: ami_find
  ec2_ami_find:
    name: "dock-ami-build-{{ ami_version }}"

- name: set ami_id
  when: ami_id is not defined
  set_fact:
    ami_id: "{{ ami_find.results[0].ami_id }}"

- name: encode ca.pem to base64
  shell: cat ./certs/ca.pem | gbase64 -w 0
  register: ca_pem_base64

- name: encode ca-key.pem to base64
  shell: cat ./certs/ca-key.pem | gbase64 -w 0
  register: ca_key_pem_base64

- name: encode pass to base64
  shell: cat ./certs/pass | gbase64 -w 0
  register: pass_base64

- name: Generate dock script
  template:
    src=init.tmpl
    dest=./dock.sh
  vars:
    is_dock_pool: false

- name: Generate dock script
  template:
    src=init.tmpl
    dest=./dock-pool.sh
  vars:
    is_dock_pool: true

- name: create dock lc
  tags: create_lc
  ec2_lc:
    name: "{{ env }}-lc-{{ ami_version }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ env }}-key"
    state: present
    region: "{{ dock_region }}"
    aws_access_key: "{{ dock_aws_access_key }}"
    aws_secret_key: "{{ dock_aws_access_secret }}"
    security_groups: ["{{ dock_security_group }}", "{{ dock_k8_security_group }}"]
    instance_type: "{{ dock_instance_type }}"
    user_data: "{{ lookup('file', './dock.sh') }}"
    instance_profile_name: "{{ dock_iam_name }}"
    volumes:
    - device_name: /dev/xvda
      volume_type: gp2
      volume_size: "{{ dock_root_disk_size_gb }}"
      delete_on_termination: true

- name: create pool lc
  tags: create_lc
  ec2_lc:
    name: "{{ env }}-pool-lc-{{ ami_version }}"
    image_id: "{{ ami_id }}"
    key_name: "{{ env }}-key"
    state: present
    region: "{{ dock_region }}"
    aws_access_key: "{{ dock_aws_access_key }}"
    aws_secret_key: "{{ dock_aws_access_secret }}"
    security_groups: ["{{ dock_security_group }}", "{{ dock_k8_security_group }}"]
    instance_type: "{{ dock_instance_type }}"
    user_data: "{{ lookup('file', './dock-pool.sh') }}"
    instance_profile_name: "{{ dock_iam_name }}"
    volumes:
    - device_name: /dev/xvda
      volume_type: gp2
      volume_size: "{{ dock_root_disk_size_gb }}"
      delete_on_termination: true
