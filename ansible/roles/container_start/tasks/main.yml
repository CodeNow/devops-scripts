---
- name: "copy find running containers with this image tag util script"
  become: true
  copy:
    src=findTagRunning.sh
    dest=/root/findTagRunning.sh
    mode=0700

# get current running container with this image
- name: "look for running containers running {{ container_image }}"
  become: true
  shell: "/root/findTagRunning.sh {{ container_image }}"
  register: old_containers_id
  changed_when: old_containers_id.stdout != ''

- name: get latest images
  when: not do_not_push
  command: sudo docker pull {{container_image}}:{{container_tag}}

- name: get id of latest image
  shell: sudo docker images --no-trunc | grep {{container_image}}.*{{container_tag}} | awk '{print $3}'
  register: new_image_id

- name: start new container
  command: sudo docker run --log-driver=none -v /var/log:/var/log:rw {{container_run_opts}} {{container_image}}:{{container_tag}} {{container_run_args}}
  register: new_container_id
  notify:
    - get new container ports
    - update redis key
    - stop old containers
