---
# get current running containers
- name: get old running containers
  shell: sudo docker ps | grep {{container_image}} | awk '{print $1}'
  register: old_containers_ids
  changed_when: old_containers_ids.stdout != ''

- name: get latest images
  command: sudo docker pull {{container_image}}:{{container_tag}}

- name: get id of latest image
  shell: sudo docker images --no-trunc | grep {{container_image}}.*{{container_tag}} | awk '{print $3}'
  register: new_image_id

- name: start new container
  command: sudo docker run {{container_run_opts}} {{container_image}}:{{container_tag}} {{container_run_args}}
  register: new_container_id
  notify:
    - get new container ports
    - update redis key
    - stop old containers
