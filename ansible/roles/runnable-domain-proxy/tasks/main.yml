---
- name: make sure cert directory is in place
  tags: [ configure_proxy, certs ]
  become: true
  file:
    dest: "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}"
    state: directory

- name: put certs in place
  tags: [ configure_proxy, certs ]
  become: true
  register: add_certs
  copy:
    src: "{{ domain }}/{{ item }}"
    dest: "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}/{{ item }}"
    mode: 0400
    owner: root
    group: root
  with_items:
  - ca.pem
  - key.pem
  - cert.pem

- name: create chained cert
  tags: [ configure_proxy, certs ]
  become: true
  when: add_certs.changed
  shell: >
    cat
    "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}/cert.pem"
    "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}/ca.pem"
    >
    "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}/chained.pem"

- name: create dhparam.pem
  tags: [ configure_proxy, certs ]
  when: add_certs.changed
  become: yes
  command: openssl dhparam -out "{{ build_dir }}/{{ name }}/ssl/certs/{{ domain }}/dhparam.pem" 2048

- name: make sure nginx directory is in place
  tags: [ configure_proxy ]
  become: true
  file:
    dest: "{{ build_dir }}/nginx"
    state: directory

- name: put nginx configuration in place
  tags: [ configure_proxy ]
  become: yes
  template:
    src: proxy-nginx.conf
    dest: "{{ build_dir }}/nginx/nginx.conf"

- name: assert nginx template directory
  tags: [ configure_proxy ]
  become: yes
  file:
    state: directory
    dest: "{{ build_dir }}/nginx/template"

- name: put api template in place
  tags: [ configure_proxy ]
  become: yes
  template:
    src: api.tmpl
    dest: "{{ build_dir }}/nginx/template/api.tmpl"
