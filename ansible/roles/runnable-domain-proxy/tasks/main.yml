---
- set_fact:
    ca_data: "{{ lookup('file', '{{ domain }}/ca.pem') }}"
- set_fact:
    cert_data: "{{ lookup('file', '{{ domain }}/{{ name }}/cert.pem') }}"
- set_fact:
    key_data: "{{ lookup('file', '{{ domain }}/{{ name }}/key.pem') }}"
- set_fact:
    chained_data: "{{ lookup('file', '{{ domain }}/{{ name }}/chained.pem') }}"
- set_fact:
    dhparam_data: "{{ lookup('file', '{{ domain }}/{{ name }}/dhparam.pem') }}"

- name: create cert config map
  tags: [ configure_proxy, configure_files ]
  template:
    dest: "{{ config_maps_path }}/{{ name }}-certs"
    src: certs.yml

- name: put nginx configuration in place
  tags: [ configure_proxy, configure_files ]
  become: yes
  template:
    src: proxy-nginx.conf
    dest: /etc/nginx/nginx.conf

- name: assert nginx template directory
  tags: [ configure_proxy, configure_files ]
  become: yes
  file:
    state: directory
    dest: /etc/nginx/template

- name: assert nginx other-sites-enabled directory
  tags: [ configure_proxy, configure_files ]
  become: yes
  file:
    state: directory
    dest: /etc/nginx/other-sites-enabled

- name: put mixpanel template in place
  tags: [ configure_proxy, configure_files ]
  become: yes
  template:
    src: mixpanel.tmpl
    dest: /etc/nginx/other-sites-enabled/mixpanel.conf

- name: put api template in place
  tags: [ configure_proxy, configure_files ]
  become: yes
  template:
    src: api.tmpl
    dest: /etc/nginx/template/api.tmpl
