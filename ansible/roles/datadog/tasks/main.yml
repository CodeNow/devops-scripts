---
- name: add https transport
  tags: ['datadog']
  sudo: yes
  apt:
    name=apt-transport-https
    state=latest

- name: add datadog apt key
  tags: ['datadog']
  sudo: yes
  apt_key:
    id=C7A7DA52
    keyserver=keyserver.ubuntu.com
    state=present

- name: add datadog repository
  tags: ['datadog']
  sudo: yes
  apt_repository:
    repo='deb http://apt.datadoghq.com/ stable main'
    state=present
    update_cache=yes

- name: Create main Datadog agent configuration file
  tags: ['datadog']
  sudo: yes
  template:
    src=datadog.conf.j2
    dest=/etc/dd-agent/datadog.conf
  notify: restart datadog-agent

- name: install network checks for dock services
  tags: ['datadog']
  sudo: yes
  when: docker_config == "docks"
  template:
    src=tcp_check.yaml.j2
    dest=/etc/dd-agent/conf.d/tcp_check.yaml
  notify: restart datadog-agent

- name: force restart
  tags: ['datadogg']
  command: echo restart datadog
  when: force_restart is defined
  notify: restart datadog-agent
