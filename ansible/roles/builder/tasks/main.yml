---
# commands to build an image
#
- name: debug!
  debug: var=hosted_ports

- name: debug dockerfile_environment
  debug: var=dockerfile_environment

- name: debug dockerfile_pre_install_commands
  debug: var=dockerfile_pre_install_commands
 
- name: debug dockerfile_post_install_commands
  debug: var=dockerfile_post_install_commands

- name: debug node_env
  debug: var=node_env

- name: debug git_branch
  debug: var=git_branch

- name: Ensure Tag Deploy For Prod
  tags: deploy
  when: not git_branch | match("^v([0-9]+)\.([0-9]+)\.([0-9]+)$") and node_env=="production-delta"
  fail: msg="only tag can be deployed on prod not {{ git_branch }}"

- name: create build folder
  become: true
  file:
    path: "{{ build_dir }}/{{ name }}"
    state: directory

- name: pull the git repository
  tags: deploy
  become: true
  git:
    repo: "{{ repo }}"
    dest: "{{ build_dir }}/{{ name }}/repo"
    version: "{{ git_branch }}"
    update: yes
    accept_hostkey: yes
    force: yes

- name: copy dockerfile to build folder
  tags: deploy
  become: true
  template:
    src: "{{ dockerfile }}"
    dest: "{{ build_dir }}/{{ name }}"

- name: build docker image and tag
  tags: deploy
  become: yes
  command: docker build {{ build_args | default("") }} --tag="{{ container_image }}:{{ container_tag }}" "{{ build_dir }}/{{ name }}"

- name: push docker image
  become: yes
  when: not do_not_push
  command: docker push {{ container_image }}:{{ container_tag }}
