---
- name: copy loggly config
  tags: loggly
  sudo: yes
  template:
    src=22-loggly.conf.j2
    dest=/etc/rsyslog.d/22-loggly.conf
    owner=root
    group=root

- name: create ubuntu bindir
  tags: loggly
  file:
    path=/home/ubuntu/bin
    state=directory
    owner=ubuntu
    group=ubuntu
    mode=0755

- name: copy rotate util script
  tags: loggly
  sudo: yes
  file:
    src=rotate-logs.sh
    dest=/home/ubuntu/bin/rotate-logs.sh
    owner=ubuntu
    group=ubuntu
    mode=0755

- name: remove file monitor config
  tags: loggly
  sudo: yes
  file:
    dest=/etc/rsyslog.d/21-filemonitoring-{{ name }}.conf
    state=absent

- name: copy app config
  tags: loggly
  sudo: yes
  template:
    src=20-output-syslog.conf.j2
    dest=/etc/rsyslog.d/20-output-{{ name }}.conf
    owner=root
    group=root

- name: copy rsyslog config
  tags: loggly
  sudo: yes
  template:
    src=rsyslog.conf.j2
    dest=/etc/rsyslog.conf
    owner=root
    group=root

- name: stop rsyslog
  tags: [loggly, deploy]
  sudo: yes
  service: name=rsyslog state=stopped

- name: clear rsyslog state file
  tags: [loggly, deploy]
  sudo: yes
  file:
    path=/var/spool/rsyslog/stat-{{ name }}
    state=absent

- name: check for current log file
  tags: [loggly, deploy]
  stat: path=/var/log/{{ name }}
  register: log_file

- name: remove old log file
  when: log_file.stat.exists
  tags: [loggly, deploy]
  sudo: yes
  file:
    path=/var/log/{{ name }}.log
    state=absent

- name: restart rsyslog
  tags: [loggly, deploy]
  sudo: yes
  service: name=rsyslog state=restarted
