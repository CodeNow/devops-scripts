ALERT HookDockUnresponsive
  IF up == 0
  FOR 10m
  LABELS {
    reportTo = "drake",
    type = "unresponsive"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock unresponsive host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "(hook) Dock unresponsive host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}"
  }

ALERT DockUnresponsive
  IF up == 0
  FOR 1h
  LABELS {
    reportTo = "pagerduty"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock unresponsive host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "Dock unresponsive host={{ $labels.hostIp }} org={{ $labels.githubOrgId }"
  }

ALERT HookDockDockerDiskFull
  IF (node_filesystem_size{device="/dev/xvdb"} - node_filesystem_free{device="/dev/xvdb"}) / node_filesystem_size{device="/dev/xvdb"}  * 100 > 70
  FOR 5m
  LABELS {
    reportTo = "drake",
    type = "disk_filled"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock /docker disk 70% host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "(hook) Dock /docker disk 70% host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}"
  }

ALERT DockDockerDiskFull
  IF (node_filesystem_size{device="/dev/xvdb"} - node_filesystem_free{device="/dev/xvdb"}) / node_filesystem_size{device="/dev/xvdb"}  * 100 > 90
  FOR 30m
  LABELS {
    reportTo = "pagerduty"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock /docker disk 90% host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "Playbook here: https://github.com/CodeNow/devops-scripts/wiki/server-out-of-disk"
  }

ALERT DockRootDiskFull
  IF (node_filesystem_size{device="/dev/xvda1"} - node_filesystem_free{device="/dev/xvda1"}) / node_filesystem_size{device="/dev/xvda1"}  * 100 > 90
  FOR 5m
  LABELS {
    reportTo = "pagerduty"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock root disk 90% host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "Playbook here: https://github.com/CodeNow/devops-scripts/wiki/server-out-of-disk"
  }

ALERT HookDockOutOfRam
  IF (node_memory_MemFree + node_memory_Buffers + node_memory_Cached) < 150000000
  FOR 5m
  LABELS {
    reportTo = "drake",
    type = "memory_exhausted"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock out of ram host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "(hook) Dock out of ram host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}"
  }

ALERT DockOutOfRam
  IF (node_memory_MemFree + node_memory_Buffers + node_memory_Cached) < 130000000
  FOR 30m
  LABELS {
    reportTo = "pagerduty"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock out of ram host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "unhealthy dock {{ $labels.hostIp } using dock-cli and message slack #customer channel with org={{ $labels.githubOrgId }}"
  }

ALERT DockHighLoad
  IF node_load15 > 90
  FOR 30m
  LABELS {
    reportTo = "pagerduty"
  }
  ANNOTATIONS {
    summary = "({{ $labels.env }}) Dock is experiencing high load host={{ $labels.hostIp }} org={{ $labels.githubOrgId }}",
    description = "ssh {{ $labels.hostIp }} into dock make sure it is responsive, if it is not, unhealthy. `docks unhealthy -e delta {{ $labels.hostIp }}`"
  }
