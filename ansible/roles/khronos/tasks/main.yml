- name: Put khronos cron script in place
  become: yes
  tags: cron
  template:
    src: "{{ item }}"
    mode: 0744
    dest: /opt/runnable/{{ item }}
  with_items:
  - khronos-cron.sh
  - build-canary.sh
  - log-canary.sh
  - github-branch-canary.sh
  - container-metrics.sh

- name: Put Khronos script into crontab
  become: yes
  tags: cron
  cron:
    name: "{{ item.name }}"
    job: /opt/runnable/{{ item.script }} >> /var/log/{{ item.script }}.log 2>&1
    minute: "{{ item.minute | default('*') }}"
    hour: "{{ item.hour | default('*') }}"
    state: "{{ item.state | default('present') }}"
  with_items:
  - name: Khronos CLI - Daily Cleanup
    minute: 13
    hour: 1,7,13,19
    script: khronos-cron.sh
  - name: Khronos CLI - Canary
    minute: "*/5"
    script: build-canary.sh
    state: "{% if node_env == 'production-delta' %}present{% else %}absent{% endif %}"
  - name: Khronos CLI - Github Branch Canary
    minute: "*/5"
    script: github-branch-canary.sh
  - name: Khronos CLI - Log Canary
    minute: "*/5"
    script: log-canary.sh
    state: "{% if node_env == 'production-delta' %}present{% else %}absent{% endif %}"
  - name: Container Metrics
    minute: "*/5"
    script: container-metrics.sh
    state: "{% if node_env == 'production-delta' %}present{% else %}absent{% endif %}"

- name: make directory for mongo certificates
  become: yes
  file:
    dest: /opt/ssl/mongo-client
    state: directory

- name: put client CA in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/ca.pem
    content: "{{ new_client_certs.data.issuing_ca }}"
    mode: 0400

- name: put client certificate in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/cert.pem
    content: "{{ new_client_certs.data.certificate }}"
    mode: 0400

- name: put client private key in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/key.pem
    content: "{{ new_client_certs.data.private_key }}"
    mode: 0400
