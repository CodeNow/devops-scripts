- name: Put khronos cron script in place
  become: yes
  tags: cron
  template:
    src="{{ item }}"
    mode=0744
    dest="/opt/runnable/{{ item }}"
  with_items:
  - khronos-cron.sh
  - build-canary.sh

# Run Cronjob at 6 hour intervals.
- name: Put Khronos CLI script in crontab
  become: yes
  tags: cron
  cron:
    name="Khronos CLI"
    minute="13"
    hour="1,7,13,19"
    job="/opt/runnable/khronos-cron.sh >> /var/log/khronos_cron.log 2>&1"

- name: Build Canary CLI script in crontab
  become: yes
  tags: cron
  when: node_env == "production-delta"
  cron:
    name: Khronos CLI
    minute: "*/5"
    job: /opt/runnable/build-canary.sh >> /var/log/build-canary.log 2>&1

# Run Cronjob once every day at 11:30am PST (19:30 UTC).
- name: Remove old Khronos CLI cronjob
  become: yes
  tags: cron
  cron:
    name="Khronos CLI Daily"
    minute="30"
    hour="19"
    job="/opt/runnable/khronos-cron.sh >> /var/log/khronos_cron.log 2>&1"
    state="absent"

- name: make directory for mongo certificates
  become: yes
  file:
    dest: /opt/ssl/mongo-client
    state: directory

- name: put client CA in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/ca.pem
    content: "{{ new_client_certs.data.issuing_ca }}"
    mode: 0400

- name: put client certificate in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/cert.pem
    content: "{{ new_client_certs.data.certificate }}"
    mode: 0400

- name: put client private key in place for mongo
  become: yes
  copy:
    dest: /opt/ssl/mongo-client/key.pem
    content: "{{ new_client_certs.data.private_key }}"
    mode: 0400
