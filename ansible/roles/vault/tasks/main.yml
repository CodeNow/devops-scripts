---
- name: create configuration directory
  become: yes
  file:
    path=/opt/runnable/vault
    state=directory
    recurse=yes

- name: create consul client certificate directory
  become: yes
  file:
    path=/opt/vault/client-consul
    state=directory
    recurse=yes

- name: create vault server tls certificate directory
  become: yes
  file:
    path=/opt/vault/server
    state=directory
    recurse=yes

- name: copy vault config
  tags: [ deploy ]
  become: true
  template:
    src=vault.hcl
    dest=/opt/runnable/vault/vault.hcl

- name: put consul certificates in place
  become: yes
  copy:
    content: "{{ item.content }}"
    dest: /opt/vault/client-consul/{{ item.file }}
    mode: 0400
    owner: root
    group: root
  with_items:
  - file: ca.pem
    content: "{{ new_client_certs.data.issuing_ca }}"
  - file: cert.pem
    content: "{{ new_client_certs.data.certificate }}"
  - file: key.pem
    content: "{{ new_client_certs.data.private_key }}"

- name: put vault server certificates in place
  become: yes
  copy:
    content: "{{ item.content }}"
    dest: /opt/vault/server/{{ item.file }}
    mode: 0400
    owner: root
    group: root
  with_items:
  - file: ca.pem
    content: "{{ new_certs.data.issuing_ca }}"
  - file: cert.pem
    content: "{{ new_certs.data.certificate }}"
  - file: key.pem
    content: "{{ new_certs.data.private_key }}"
