#- include_vars: '../../../../group_vars/{{node_env}}.yml'

- name: Path of nodejs
  command: which node
  register: node_result
  ignore_errors: yes

- name: Checking nodejs dependencies
  fail: msg="Nodejs has not installed or node binary is not in your path."
  when: node_result|failed

- name: Adding iptables log to another iptable file
  become: true
  template: src=10-iptables.conf.j2 dest=/etc/rsyslog.d/10-iptables.conf
  notify: 
  - restart rsyslog

- name: installing psad to latest version
  apt: pkg=psad state=latest update_cache=yes cache_valid_time=3600
  become: true
  notify:
  - restart psad

- name: psad signature update 
  shell: psad --sig-update && psad -H
  register: command_result
  failed_when: "'FAILED' in command_result.stderr"
  become: true

- debug: var=command_result

- name: make folder for notification script 
  file: path={{psad_script_folder}} state=directory recurse=yes
  become: true

- name: make psad script that will run on startup
  template: src=psad_scritp.js.j2 dest={{psad_script_folder}}/psad_script.js mode=u+x
  become: true

- name: copy package.json to installation dir
  template: src=psad_script_package.json.j2 dest={{psad_script_folder}}/package.json
  become: true

- name: installing npm package
  npm: path={{psad_script_folder}}
  become: true

- name: ensuring psad configuration file is in correct state.
  template:
    dest=/etc/psad/psad.conf
    src=psad.conf.j2
    owner=root
    mode=0644
  become: true
  notify:
  - restart psad

