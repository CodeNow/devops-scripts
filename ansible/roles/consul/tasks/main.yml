---
- name: create configuration directory
  become: yes
  file:
    path=/opt/runnable/consul
    state=directory
    recurse=yes

- name: create server tls certificate directory
  become: yes
  file:
    path=/opt/consul/server
    state=directory
    recurse=yes

- name: copy vault config
  become: yes
  template:
    src=consul.json.j2
    dest=/opt/runnable/consul/consul.json

- name: copy tls certificates (3)
  become: true
  copy:
    src=certs/consul/server/{{ ansible_default_ipv4.address }}/{{ item }}
    dest=/opt/consul/server/{{ item }}
    mode=0400
    owner=root
    group=root
  with_items:
    - ca.pem
    - cert.pem
    - key.pem

- name: add datadog monitoring
  become: true
  tags: datadog
  template:
    src: datadog-consul.yaml.j2
    dest: /etc/dd-agent/conf.d/consul.yaml
    mode: 0444
    owner: root
    group: root

- name: restart datadog agent
  become: true
  tags: datadog
  service:
    name: datadog-agent
    state: restarted
