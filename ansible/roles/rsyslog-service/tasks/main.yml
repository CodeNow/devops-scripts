---
- name: Install rsyslog-gnutls
  become: yes
  tags: loggly
  apt:
    pkg=rsyslog-gnutls
    state=latest
    update_cache=yes
    cache_valid_time=604800
    install_recommends=yes

- name: copy loggly TLS config
  tags: loggly
  become: true
  copy:
    src=10-loggly-tls.conf
    dest=/etc/rsyslog.d/10-loggly-tls.conf
    owner=syslog
    group=syslog

- name: create loggly TLS cert dir
  tags: loggly
  become: true
  file:
    path=/etc/rsyslog.d/keys/ca.d
    state=directory
    owner=syslog
    group=syslog
    
- name: fix /docker mode
  tags: loggly
  become: true
  file:
    path=/docker
    state=directory
    owner=root
    group=root
    mode=0755

- name: create "{{ rsyslog_dir }}"
  tags: loggly
  become: true
  file:
    path="{{ rsyslog_dir }}"
    state=directory
    owner=syslog
    group=syslog
    mode=0755

- name: copy loggly TLS certs
  tags: loggly
  become: true
  copy:
    src=loggly_full.crt
    dest=/etc/rsyslog.d/keys/ca.d/loggly_full.crt
    owner=syslog
    group=syslog
    mode=400

- name: copy loggly config
  tags: loggly
  sudo: yes
  template:
    src=99-catchall-loggly.conf.j2
    dest=/etc/rsyslog.d/99-loggly.conf
    owner=syslog
    group=syslog

- name: create runnable bin directory
  tags: loggly
  sudo: yes
  file:
    path=/opt/runnable/bin
    state=directory
    mode=0755
    owner=ubuntu
    group=ubuntu

- name: copy app datetime config
  tags: [ loggly, datetime ]
  sudo: yes
  template:
    src=20-datetime-app.conf.j2
    dest=/etc/rsyslog.d/20-datetime-{{ name }}.conf
    owner=syslog
    group=syslog

- name: copy app truncation config
  tags: [ loggly, truncate ]
  sudo: yes
  template:
    src=25-truncate-app.conf.j2
    dest=/etc/rsyslog.d/25-truncate-{{ name }}.conf
    owner=syslog
    group=syslog

- name: copy rsyslog config
  tags: loggly
  sudo: yes
  template:
    src=rsyslog.conf.j2
    dest=/etc/rsyslog.conf
    owner=syslog
    group=syslog

- name: stop rsyslog
  tags: [loggly, deploy]
  sudo: yes
  service: name=rsyslog state=stopped

- name: clear rsyslog state file
  tags: [loggly, deploy]
  sudo: yes
  file:
    path=/var/spool/rsyslog/stat-{{ name }}
    state=absent

- name: restart rsyslog
  tags: [loggly, deploy]
  sudo: yes
  service: name=rsyslog state=restarted
