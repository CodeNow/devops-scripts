---
- name: get ports from socket-server
  delegate_to: "{{ groups['socket-server'][0] }}"
  tags: [ config, deploy ]
  become: true
  shell: "for c in $(docker ps | awk '/api-socket-server/{ print $1 }'); do docker port $c 80 | cut -d ':' -f 2; done"
  args:
    executable: /bin/bash
  register: ports

- name: register socket server IP as variable
  tags: [ config, deploy ]
  set_fact:
    socket_server_hostname: "{{ hostvars[groups['socket-server'][0]].ansible_default_ipv4.address }}"

- name: make nginx config directory
  tags: [ config, deploy ]
  become: yes
  file:
    state: directory
    dest: /etc/nginx

- name: list files in config directory
  tags: [ config, deploy ]
  become: yes
  command: ls /etc/nginx/sites-available
  register: sites_available

- name: remove all sites
  tags: [ config, deploy ]
  become: yes
  command: rm -f {{ item }}
  with_items: "{{ sites_available.stdout_lines }}"

- name: put configuration in place
  tags: [ config, deploy ]
  become: yes
  template:
    src: "{{ item }}"
    dest: /etc/nginx/sites-available/{{ item }}
  with_items:
    - 00-nginx-status.conf
    - 01-socket-server.conf

- name: put nginx configuration in place
  tags: [ config, deploy ]
  become: yes
  copy:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
