---
- hosts: docks
  vars_files:
    - "group_vars/alpha-docks.yaml"
  roles:
    - docker
  tasks:
    #check if dockhost already in redis
  - command: sudo docker run --rm redis redis-cli -h {{redis_host}} lrange {{replace_key}} 0 -1
    register: key_length
    tags: dock_key

  # create key if not exist
  - command: sudo docker run --rm redis redis-cli -h {{redis_host}} rpush {{replace_key}} http://{{ansible_default_ipv4.address}}:4242
    when: key_length.stdout.find("{{ansible_default_ipv4.address}}") == -1
    tags: dock_key

  # check keys
  - command: sudo docker run --rm redis redis-cli -h {{redis_host}} hlen http://{{ansible_default_ipv4.address}}:4242
    register: key_length
    tags: dock_key

  # create key if not exist
  - command: sudo docker run --rm redis redis-cli -h {{redis_host}} hmset http://{{ansible_default_ipv4.address}}:4242 numContainers 0 numBuilds 0 host http://{{ansible_default_ipv4.address}}:4242
    when: key_length.stdout == "0"
    tags: dock_key

- include: krain.yaml
- include: filibuster.yml