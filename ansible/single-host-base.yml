---
- hosts: localhost
  connection: local
  tasks:
  - fail: msg="`host` (target host) needs to be defined to run this role"
    when: host is not defined

  - add_host:
      name={{ host }}
      groups=dock

- hosts: "{{ host }}"
  roles:
  - { role: git }
  tasks:
  - name: Install docker-squash
    pip:
      name: docker-squash

  - name: build and squash all images
    include_role:
      name: build_and_squash_image
      private: true
      vars_from: main
    vars:
      service_name: "{{ item.name }}"
      name: "{{ item.name }}aaaa"
      git_branch: "{{ item.git_branch }}"
    with_items:
    - { name: 'sauron', git_branch: "{{ sauron_branch }}" }
    - { name: 'palantiri', git_branch: "{{ palantiri_branch }}" }
    - { name: 'shiva', git_branch: "{{ astral_branch }}" }
    - { name: 'khronos', git_branch: "{{ khronos_branch }}" }
    - { name: 'docker-listener', git_branch: "{{ docker_listener_branch }}" }
    - { name: 'big-poppa', git_branch: "{{ big_poppa_branch }}" }
    - { name: 'api', git_branch: "{{ api_branch }}" }
    - { name: 'drake', git_branch: "{{ drake_branch }}" }
    - { name: 'cream', git_branch: "{{ cream_branch }}" }
    - { name: 'web', git_branch: "{{ angular_branch }}" }
    - { name: 'detention', git_branch: "{{ detention_branch }}" }
    - { name: 'link', git_branch: "{{ link_branch }}" }
    - { name: 'navi', git_branch: "{{ navi_branch }}" }
    - { name: 'optimus', git_branch: "{{ optimus_branch }}" }
    - { name: 'pheidi', git_branch: "{{ pheidi_branch }}" }
