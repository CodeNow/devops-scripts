name: consul

# for database role
db_path: /etc/consul.d

# for container_kill_start
pause_length_minutes: 3

container_image: runnable/consul
container_tag: v0.5.2

container_run_opts: >
  -d
  -h {{ inventory_hostname }}
  -v /consul:/data
  -v /etc/consul.d:/etc/consul.d:ro
  -v /var/log:/var/log
  -p {{ ansible_default_ipv4.address }}:8300:8300
  -p {{ ansible_default_ipv4.address }}:8301:8301
  -p {{ ansible_default_ipv4.address }}:8301:8301/udp
  -p {{ ansible_default_ipv4.address }}:8302:8302
  -p {{ ansible_default_ipv4.address }}:8302:8302/udp
  -p {{ ansible_default_ipv4.address }}:8400:8400
  -p {{ ansible_default_ipv4.address }}:8500:8500
  --restart=always

container_run_args: >
  consul agent
  -server
  -node {{ inventory_hostname }}
  -advertise {{ ansible_default_ipv4.address }}
  -config-dir /etc/consul.d
  -client 0.0.0.0
  -recursor 8.8.8.8
  {% if consul_hostname == ansible_default_ipv4.address %}-bootstrap-expect {{ groups['consul'] | length }}{% endif %}
  -data-dir /data
  {% if consul_hostname == ansible_default_ipv4.address %}-ui-dir /ui{% endif %}
  {% if consul_hostname != ansible_default_ipv4.address %}-retry-join {{ consul_hostname }}{% endif %}
  > /var/log/consul.log 2>&1

# some seed values
# pulled 2015/16/11 - Bryan
consul_seed:
  - key: node/env
    value: "{{ node_env }}"
  - key: api/hostname
    value: "{{ api_hostname }}"
