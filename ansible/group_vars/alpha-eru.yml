---
name: eru

container_image: registry.runnable.com/runnable/{{ name }}
container_tag: "{{ git_branch }}"
repo: git@github.com:CodeNow/{{ name }}.git
hosted_ports: [ "5501", "5502" ]
node_version: 4.4.4
npm_version: 3.8
has_shrinkwrap: true

dockerfile_post_install_commands:
- apt-get update && apt-get install -y supervisor
- npm run build

container_envs: >-
  -e AWS_ACCESS_KEY={{ eru_aws_access_key_id }}
  -e AWS_ENVIRONMENT={{ eru_aws_environment }}
  -e AWS_SECRET_KEY={{ eru_aws_secret_access_key }}
  -e CONSUL_HOST={{ consul_host_address }}:{{ consul_api_port }}
  -e DOMAIN={{ eru_subdomain }}.{{ domain }}
  -e GITHUB_CLIENT_ID={{ eru_github_id }}
  -e GITHUB_CLIENT_SECRET={{ eru_github_secret }}
  -e INTERCOM_API_KEY={{ eru_intercom_key }}
  -e INTERCOM_APP_ID={{ eru_intercom_id }}
  -e LOG_ENVIRONMENT={{ node_env }}
  -e LOG_LEVEL=trace
  -e MONGODB_DATABASE={{ eru_mongodb_database }}
  -e MONGODB_HOSTS={{ mongo_hosts }}
  -e MONGODB_PASSWORD={{ eru_mongodb_password }}
  -e MONGODB_REPLSET={{ eru_mongodb_replset }}
  -e MONGODB_USERNAME={{ eru_mongodb_username }}
  -e NODE_ENV=production
  -e RABBITMQ_HOSTNAME={{ rabbit_host_address }}
  -e RABBITMQ_PASSWORD={{ rabbit_password }}
  -e RABBITMQ_PORT={{ rabbit_port }}
  -e RABBITMQ_USERNAME={{ rabbit_username }}
  -e REDIS_HOSTNAME={{ redis_host_address }}
  -e REDIS_PORT={{ redis_port }}
  -e RUNNABLE_DOMAIN={{ domain }}
  -e USER_CONTENT_DOMAIN={{ user_content_domain }}

container_run_opts: >
  -h {{ name }}
  -d
  -P
  -v /var/log:/var/log:rw
  {{ container_envs }}

container_run_args: bash -c "supervisord --configuration supervisord.conf && sleep 10 && tail -n 100 -qf /tmp/*std*.log /tmp/supervisord.log"
