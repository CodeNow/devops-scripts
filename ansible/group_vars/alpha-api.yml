name: "api"

# for rollbar deploy info
rollbar_token: a90d9c262c7c48cfabbd32fd0a1bc61c

container_image: registry.runnable.com/runnable/{{ name }}
container_tag: "{{ git_branch }}"
repo: "git@github.com:CodeNow/{{ name }}.git"
hosted_ports: ["80"]
node_version: "0.10.38"
npm_version: "2.8.3"

# for redis
redis_key: "frontend:api.{{ domain }}"
is_redis_update_required: 'yes'
datadog_host: "{{ ansible_default_ipv4.address }}"

mongo_hosts: "{% for host in groups['mongodb'] %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}:27000{% if not loop.last %},{% endif %}{% endfor %}"
neo4j_host: "{{ hostvars[groups['neo4j'][0]]['ansible_default_ipv4']['address'] }}"
redis_host: "{{ hostvars[groups['redis'][0]]['ansible_default_ipv4']['address'] }}"

# for container settings
container_envs: >
  -h api
  -e AWS_ACCESS_KEY_ID={{ api_aws_access_key_id }}
  -e AWS_SECRET_ACCESS_KEY={{ api_aws_secret_access_key }}
  -e DATADOG_HOST={{ datadog_host }}
  -e DATADOG_PORT={{ datadog_port }}
  -e DOMAIN={{ domain }}
  -e GITHUB_CALLBACK_URL=https://api.{{ domain }}/auth/github/callback
  -e GITHUB_CLIENT_ID={{ api_github_client_id }}
  -e GITHUB_CLIENT_SECRET={{ api_github_client_secret }}
  -e GITHUB_DEPLOY_KEYS_BUCKET={{ api_github_deploy_keys_bucket }}
  -e GITHUB_HOOK_URL=https://api.{{ domain }}/actions/github
  -e HELLO_RUNNABLE_GITHUB_TOKEN={{ api_hello_runnable_github_token }}
  -e MAVIS_HOST=http://mavis.{{ domain }}:80
  -e MIXPANEL_APP_ID={{ api_mixpanel_app_id }}
  -e MONGO=mongodb://{{ api_mongo_auth }}@{{ mongo_hosts }}/{{ api_mongo_database }}
  -e MONGO_REPLSET_NAME={{ api_mongo_replset_name }}
  -e NAVI_HOST=http://navi.{{ domain }}
  -e NAVI_HOST=http://{{ hostvars[groups['navi'][0]]['ansible_default_ipv4']['address'] }}:3567
  -e NEO4J={{ api_neo4j_protocol }}{{ api_neo4j_auth }}@{{ neo4j_host }}:{{ api_neo4j_port }}
  -e NEW_RELIC_APP_NAME={{ api_new_relic_app_name }}
  -e NEW_RELIC_LICENSE_KEY={{ new_relic_license_key }}
  -e NEW_RELIC_LOG_LEVEL=fatal
  -e NEW_RELIC_NO_CONFIG_FILE=true
  -e NODE_ENV={{ node_env }}
  -e NUM_WORKERS=1
  -e OPTIMUS_HOST=http://optimus.{{ domain }}
  -e RABBITMQ_HOSTNAME={{ rabbit_host | default(hostvars[groups['rabbitmq'][0]]['ansible_default_ipv4']['address']) }}
  -e RABBITMQ_PASSWORD={{ rabbit_password }}
  -e RABBITMQ_PORT={{ rabbit_port }}
  -e RABBITMQ_USERNAME={{ rabbit_username }}
  -e REDIS_IPADDRESS={{ redis_host }}
  -e REDIS_PORT=6379
  -e ROLLBAR_KEY={{ api_rollbar_key }}
  -e S3_CONTEXT_RESOURCE_BUCKET={{ api_s3_context_bucket }}
  -e USER_CONTENT_DOMAIN={{ user_content_domain }}
  -e DOCKER_IMAGE_BUILDER_WEAVE_PATH={{ weave_path }}

container_run_opts: >
  -d
  -P
  -v /opt/ssl/docker/{{ name }}:/etc/ssl/docker:ro
  {{ container_envs }}
